<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>学园偶像大师 BOX分享工具</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .is-unowned { filter: brightness(0.4); }
        .unowned-mask { background-color: rgba(0, 0, 0, 0.6); }
        .icon-dimmed { filter: brightness(0.6) saturate(0.8); opacity: 0.7; }
        .rarity-icon { height: 18px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8)); }
        .attr-icon { height: 24px; width: auto; z-index: 40; }
        @media (min-width: 640px) { .rarity-icon { height: 26px; } .attr-icon { height: 36px; } }
        .filter-btn { height: 38px; min-width: 80px; flex: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 800; font-size: 11px; transition: all 0.2s ease; border: 1px solid rgba(255,255,255,0.05); }
        .btn-ssr-active { background: linear-gradient(135deg, #22d3ee, #3b82f6, #a855f7, #facc15); color: white; border: none; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .btn-sr-active { background: linear-gradient(180deg, #fef08a 0%, #eab308 50%, #a16207 100%); color: #422006; border: none; box-shadow: 0 4px 15px rgba(234, 179, 8, 0.3); }
        .btn-vo-active { background-color: #ef4444; color: white; border: none; }
        .btn-da-active { background-color: #3b82f6; color: white; border: none; }
        .btn-vi-active { background-color: #eab308; color: #422006; border: none; }
        .btn-as-active { background-color: #22c55e; color: white; border: none; }
        .btn-inactive { background-color: #1e293b; color: #64748b; }
        .card-img { opacity: 0; transition: opacity 0.4s ease-out; }
        .card-img-loaded { opacity: 1 !important; }
        .lvl-text { text-shadow: 0 0 10px rgba(0,0,0,0.9); font-family: 'Arial Black', sans-serif; }
        .tap-feedback:active { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body class="antialiased select-none">
    <div id="app" class="max-w-[1600px] mx-auto px-2 py-4 sm:px-4 sm:py-8">
        
        <header class="mb-6 flex flex-col lg:flex-row lg:items-end justify-between gap-6">
            <div>
                <h1 class="text-2xl sm:text-3xl font-black text-indigo-500 tracking-tighter mb-4">学园偶像大师 BOX分享工具</h1>
                <div class="flex gap-2">
                    <button @click="importCode" class="text-[10px] bg-slate-800 px-3 py-1.5 rounded-lg text-slate-300 hover:bg-slate-700 transition">导入代码</button>
                    <button @click="resetData" class="text-[10px] bg-red-950/30 px-3 py-1.5 rounded-lg text-red-400 hover:bg-red-900/50 transition">清空数据</button>
                </div>
            </div>
            
            <div class="flex flex-col items-end gap-3 w-full lg:w-auto">
                <button @click="generateSummaryImage" :disabled="isGenerating || ownedCount === 0"
                        class="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 text-white px-8 py-3 rounded-xl font-bold transition w-full lg:w-auto shadow-xl">
                    <span v-if="isGenerating" class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></span>
                    <span>{{ isGenerating ? '正在绘图...' : '生成汇总长图' }}</span>
                </button>
                <div @click="copyResult" class="bg-slate-900 border border-slate-800 rounded-2xl p-3 cursor-pointer w-full lg:max-w-md group relative text-right">
                    <div class="text-[8px] text-slate-500 mb-1 uppercase tracking-widest font-bold">压缩分享代码 (点击复制)</div>
                    <div class="font-mono text-[10px] text-indigo-400 truncate">{{ exportString || 'Waiting...' }}</div>
                </div>
            </div>
        </header>

        <div class="bg-slate-900/60 p-4 rounded-2xl border border-slate-800/50 mb-6">
            <div class="flex flex-wrap items-center gap-2 sm:gap-3">
                <button @click="toggleRarityFilter('3')" :class="[selectedRarities.includes('3') ? 'btn-ssr-active' : 'btn-inactive']" class="filter-btn">SSR</button>
                <button @click="toggleRarityFilter('2')" :class="[selectedRarities.includes('2') ? 'btn-sr-active' : 'btn-inactive']" class="filter-btn">SR</button>
                <div class="hidden sm:block w-px h-8 bg-slate-800 mx-1"></div>
                <button @click="toggleFilter('vo')" :class="[selectedAttrs.includes('vo') ? 'btn-vo-active' : 'btn-inactive']" class="filter-btn text-[10px]">VOCAL</button>
                <button @click="toggleFilter('da')" :class="[selectedAttrs.includes('da') ? 'btn-da-active' : 'btn-inactive']" class="filter-btn text-[10px]">DANCE</button>
                <button @click="toggleFilter('vi')" :class="[selectedAttrs.includes('vi') ? 'btn-vi-active' : 'btn-inactive']" class="filter-btn text-[10px]">VISUAL</button>
                <button @click="toggleFilter('as')" :class="[selectedAttrs.includes('as') ? 'btn-as-active' : 'btn-inactive']" class="filter-btn text-[10px]">ASSIST</button>
                <button v-if="selectedAttrs.length > 0 || selectedRarities.length > 0" @click="clearAllFilters" class="ml-auto text-[10px] font-bold text-slate-500 hover:text-red-400 px-2 transition-colors">RESET ✕</button>
            </div>
        </div>

        <div class="flex items-center gap-3 bg-indigo-500/5 border border-indigo-500/20 p-3 rounded-xl mb-6">
            <p class="text-[11px] sm:text-xs text-indigo-200/80 leading-relaxed">
                点击卡片 <span class="text-white font-bold">左侧</span> 降低等级，点击 <span class="text-white font-bold">右侧</span> 增加等级；<span class="text-indigo-400 font-bold underline">长按右侧</span> 直接设定满级 (LV.4)。
            </p>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3 sm:gap-6">
            <div v-for="card in filteredCards" :key="card.rarity + '-' + card.id" 
                 class="relative aspect-video rounded-xl sm:rounded-[2rem] overflow-hidden bg-slate-950 border border-slate-800 transition-transform active:scale-[0.98]">
                <img :src="'./static/cards/s_card-' + card.rarity + '-' + card.id + '.webp'" 
                     loading="lazy" @load="card.loaded = true"
                     :class="['w-full h-full object-cover card-img', card.loaded ? 'card-img-loaded' : '', card.breakLevel === -1 ? 'is-unowned' : '']">
                <div v-if="card.breakLevel === -1 && card.loaded" class="absolute inset-0 unowned-mask z-10 pointer-events-none"></div>
                <div class="absolute inset-0 flex z-30" v-if="card.loaded">
                    <div @click.stop="changeLevel(card, -1)" class="w-1/2 h-full tap-feedback cursor-pointer"></div>
                    <div @click.stop="changeLevel(card, 1)" 
                         @mousedown="startLongPress(card)" @touchstart.passive="startLongPress(card)" 
                         @mouseup="endLongPress" @touchend="endLongPress" @mouseleave="endLongPress"
                         class="w-1/2 h-full tap-feedback cursor-pointer"></div>
                </div>
                <div class="absolute top-3 left-3 sm:top-5 sm:left-5 z-20" v-if="card.loaded">
                    <img :src="'./static/assets/' + (card.rarity === '3' ? 'ssr' : 'sr') + '_icon.webp'" 
                         :class="['rarity-icon', card.breakLevel === -1 ? 'icon-dimmed' : '']">
                </div>
                <div class="absolute top-2 right-2 sm:top-4 sm:right-4 z-40" v-if="card.loaded">
                    <img v-if="card.attribute" :src="'./static/assets/icon_' + card.attribute + '.webp'" 
                         :class="['attr-icon', card.breakLevel === -1 ? 'icon-dimmed' : '']">
                </div>
                <div class="absolute bottom-3 left-4 sm:bottom-5 sm:left-6 z-20" v-if="card.loaded">
                    <div class="lvl-text text-xl sm:text-3xl font-black italic tracking-tighter" :class="card.breakLevel === -1 ? 'text-slate-600' : 'text-white'">
                        {{ getLevelDisplay(card) }}
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/95" @click.self="showModal = false">
            <div class="bg-slate-900 p-5 rounded-3xl max-w-4xl w-full max-h-[92vh] flex flex-col border border-slate-800">
                <div class="flex justify-between items-center mb-4 text-white font-bold px-2">
                    <span class="text-sm">生成的汇总图 (长按保存)</span>
                    <button @click="showModal = false" class="bg-slate-800 w-8 h-8 rounded-full flex items-center justify-center hover:text-red-400">✕</button>
                </div>
                <div class="flex-1 overflow-y-auto bg-black rounded-2xl p-2 text-center">
                    <img :src="generatedImageSrc" class="max-w-full mx-auto rounded-lg shadow-2xl">
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const STORAGE_KEY = 'gakuen_box_data_v6'; // 更新版本号

        createApp({
            data() { 
                return { 
                    cards: [], showModal: false, generatedImageSrc: null, 
                    isGenerating: false, selectedAttrs: [], selectedRarities: [],
                    longPressTimer: null, isLongPressActive: false
                } 
            },
            computed: {
                ownedCount() { return this.cards.filter(c => c.breakLevel >= 0).length; },
                
                // 【核心修改1】导出：全量等级序列化 + Base36
                exportString() { 
                    // 1. 获取所有卡片的原始状态（固定顺序：按稀有度及ID排序后的 cards 数组）
                    // 状态：0(未点亮), 1-5(Lv.0-4)
                    const statusString = this.cards.map(c => c.breakLevel + 1).join('');
                    
                    // 2. 将这串数字视为一个大整数，转为 36 进制字符串以极度压缩长度
                    // 在前面补 1 是为了防止首位为 0 时在大数转换中丢失
                    return statusString ? BigInt('1' + statusString).toString(36) : '';
                },
                
                filteredCards() {
                    let result = [...this.cards];
                    if (this.selectedRarities.length > 0) result = result.filter(c => this.selectedRarities.includes(c.rarity));
                    if (this.selectedAttrs.length > 0) result = result.filter(c => c.attribute && this.selectedAttrs.includes(c.attribute));
                    return result.sort((a, b) => (Number(b.rarity) - Number(a.rarity)) || (Number(b.id) - Number(a.id)));
                }
            },
            methods: {
                // Base36 解码大整数助手
                fromBase36(s) {
                    return [...s].reduce((acc, curr) => acc * 36n + BigInt(parseInt(curr, 36)), 0n);
                },

                getLevelDisplay(card) {
                    const lv = card.breakLevel;
                    if (lv === -1) return 'OFF';
                    const base = card.rarity === '3' ? 40 : 30;
                    return `LV.${base + (lv * 5)}`;
                },
                startLongPress(card) {
                    this.isLongPressActive = false;
                    this.longPressTimer = setTimeout(() => {
                        this.isLongPressActive = true;
                        card.breakLevel = 4;
                        this.saveToLocal();
                        if (window.navigator.vibrate) window.navigator.vibrate(60);
                    }, 600);
                },
                endLongPress() { clearTimeout(this.longPressTimer); setTimeout(() => { this.isLongPressActive = false; }, 100); },
                changeLevel(card, step) {
                    if (this.isLongPressActive) return;
                    let next = card.breakLevel + step;
                    if (next > 4) next = 4; if (next < -1) next = -1;
                    if (card.breakLevel !== next) { card.breakLevel = next; this.saveToLocal(); }
                },

                init() {
                    const localData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                    const allCards = [];
                    // 这里确立了固定的序列顺序：CARD_CONFIG 的属性遍历顺序
                    for (const [attr, rarities] of Object.entries(CARD_CONFIG)) {
                        for (const [rarity, ids] of Object.entries(rarities)) {
                            ids.forEach(id => {
                                const paddedId = String(id).padStart(4, '0');
                                allCards.push({ 
                                    id: paddedId, 
                                    rarity: String(rarity), 
                                    breakLevel: localData[paddedId] !== undefined ? localData[paddedId] : -1, 
                                    attribute: attr.toLowerCase(), 
                                    loaded: false 
                                });
                            });
                        }
                    }
                    // 统一排序：这是序列化的基准，不可随意更改
                    this.cards = allCards.sort((a, b) => (Number(b.rarity) - Number(a.rarity)) || (Number(b.id) - Number(a.id)));
                },

                // 【核心修改2】导入：Base36 解码并按位置还原状态
                importCode() {
                    const input = prompt("请粘贴导出的压缩代码：");
                    if (!input || input.trim() === "") return;
                    
                    try {
                        // 1. 从 36 进制还原为数字字符串
                        let decoded = this.fromBase36(input.trim().toLowerCase()).toString();
                        
                        // 2. 去掉开头补位的 '1'
                        const statusArray = decoded.substring(1).split('');
                        
                        // 3. 校验长度（必须与当前牌库总数一致）
                        if (statusArray.length !== this.cards.length) {
                            alert("请检查代码：由于牌库版本变动，该代码已失效。");
                            return;
                        }

                        // 4. 按顺序还原
                        statusArray.forEach((val, index) => {
                            const lv = parseInt(val) - 1;
                            if (lv >= -1 && lv <= 4) {
                                this.cards[index].breakLevel = lv;
                            }
                        });

                        this.saveToLocal();
                        alert("BOX 成功继承！");
                    } catch (e) {
                        alert("无效的代码格式");
                    }
                },

                // ... 其他方法保持不变 ...
                saveToLocal() {
                    const storage = {};
                    this.cards.forEach(c => { if (c.breakLevel !== -1) storage[c.id] = c.breakLevel; });
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(storage));
                },
                resetData() { if (confirm("确定重置？")) { this.cards.forEach(c => c.breakLevel = -1); this.saveToLocal(); } },
                downloadImg(src) { return new Promise((res, rej) => { const i = new Image(); i.crossOrigin="anonymous"; i.onload = () => res(i); i.onerror = rej; i.src = src; }); },
                async generateSummaryImage() {
                    const list = this.filteredCards.filter(c => c.breakLevel >= 0);
                    if (list.length === 0) return;
                    this.isGenerating = true;
                    try {
                        const cols = 3; const cardW = 640; const cardH = 360;
                        const rows = Math.ceil(list.length / cols);
                        const canvas = document.createElement('canvas');
                        canvas.width = cols * cardW; canvas.height = rows * cardH;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#020617'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                        const ui = {
                            ssr: await this.downloadImg('./static/assets/ssr_icon.webp'),
                            sr: await this.downloadImg('./static/assets/sr_icon.webp'),
                            vo: await this.downloadImg('./static/assets/icon_vo.webp'),
                            da: await this.downloadImg('./static/assets/icon_da.webp'),
                            vi: await this.downloadImg('./static/assets/icon_vi.webp'),
                            as: await this.downloadImg('./static/assets/icon_as.webp')
                        };
                        for (let i = 0; i < list.length; i++) {
                            const c = list[i]; const x = (i % cols) * cardW; const y = Math.floor(i / cols) * cardH;
                            const img = await this.downloadImg(`./static/cards/s_card-${c.rarity}-${c.id}.webp`);
                            ctx.drawImage(img, x, y, cardW, cardH);
                            ctx.drawImage(c.rarity==='3'?ui.ssr:ui.sr, x + 25, y + 25, 80, 40);
                            if (c.attribute) ctx.drawImage(ui[c.attribute], x + cardW - 110, y + 15, 95, 95);
                            ctx.save(); ctx.shadowColor = 'black'; ctx.shadowBlur = 12;
                            ctx.fillStyle = 'white'; ctx.font = 'italic 900 70px Arial Black'; 
                            ctx.fillText(this.getLevelDisplay(c), x + 30, y + cardH - 30);
                            ctx.restore();
                        }
                        this.generatedImageSrc = canvas.toDataURL('image/jpeg', 0.88);
                        this.showModal = true;
                    } catch (e) { alert("生成失败"); } finally { this.isGenerating = false; }
                },
                copyResult() { 
                    if (!this.exportString) return;
                    const el = document.createElement('textarea');
                    el.value = this.exportString; document.body.appendChild(el);
                    el.select(); document.execCommand('copy');
                    document.body.removeChild(el); alert("已复制极简分享代码");
                }
            },
            mounted() { this.init() }
        }).mount('#app');
    </script>
</body>
</html>