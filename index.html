<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>学园偶像大师 BOX分享工具</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .is-unowned { filter: brightness(0.5); }
        .icon-grayscale { filter: grayscale(100%) brightness(0.6) contrast(0.8) drop-shadow(0 1px 2px rgba(0,0,0,0.5)) !important; opacity: 0.8; }
        .unowned-mask {background-color: rgba(0, 0, 0, 0.3); /* 50% 黑色遮罩 */
                       transition: all 0.3s ease;}
        .icon-dimmed {filter: brightness(0.6) saturate(0.8);
                      opacity: 0.7;}
        /* 响应式图标 */
        .rarity-icon { height: 18px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8)); transition: all 0.3s; }
        .attr-icon { height: 24px; width: auto; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.9)); z-index: 40; transition: all 0.3s; }
        @media (min-width: 640px) {
            .rarity-icon { height: 26px; }
            .attr-icon { height: 36px; }
        }
        /* 骨架屏动画 */
        @keyframes skeleton-loading {
            0% { background-color: #0f172a; }
            50% { background-color: #1e293b; }
            100% { background-color: #0f172a; }
        }
        .skeleton { animation: skeleton-loading 1.5s infinite ease-in-out; }

        /* 图片懒加载淡入 */
        .card-img { opacity: 0; transition: opacity 0.6s ease-out, filter 0.3s; }
        .card-img-loaded { opacity: 1 !important; }

        .lvl-text { text-shadow: 0 0 10px rgba(0,0,0,0.9), 0 0 20px rgba(99, 102, 241, 0.4); font-family: 'Arial Black', sans-serif; }
        .tap-feedback:active { background: rgba(255,255,255,0.08); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #6366f1; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased select-none">
    <div id="app" class="max-w-[1600px] mx-auto px-2 py-4 sm:px-4 sm:py-8">
        
        <header class="mb-6 flex flex-col md:flex-row md:items-end justify-between gap-4 sm:gap-6">
            <div>
                <h1 class="text-2xl sm:text-3xl font-black text-indigo-500 tracking-tighter mb-2 sm:mb-4">学园偶像大师 BOX分享工具</h1>
                <div class="flex gap-2">
                    <button @click="importCode" class="text-[10px] sm:text-[11px] bg-indigo-900/50 px-2.5 py-1 sm:px-3 sm:py-1.5 rounded-lg text-indigo-300 hover:bg-indigo-800 hover:text-white transition">导入数据</button>
                    <button @click="resetData" class="text-[10px] sm:text-[11px] bg-red-900/50 px-2.5 py-1 sm:px-3 sm:py-1.5 rounded-lg text-red-300 hover:bg-red-800 hover:text-white transition">清空选择</button>
                </div>
                <div class="mt-3 text-[9px] sm:text-[10px] text-slate-500 font-bold uppercase tracking-widest">当前已点亮 {{ ownedCount }} 张卡片</div>
            </div>
            
            <div class="flex flex-col items-end gap-3 w-full md:w-auto">
                <button @click="generateSummaryImage" :disabled="isGenerating || ownedCount === 0"
                        class="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 text-white px-4 py-2.5 sm:px-6 sm:py-3 rounded-xl font-bold transition w-full md:w-auto text-sm sm:text-base">
                    <div v-if="isGenerating" class="loader"></div>
                    <span>{{ isGenerating ? '正在绘图...' : '生成汇总长图' }}</span>
                </button>
                <div @click="copyResult" class="bg-slate-900 border border-slate-800 rounded-xl sm:rounded-2xl p-3 sm:p-4 cursor-pointer w-full md:max-w-md group relative">
                    <div class="text-[8px] sm:text-[9px] text-slate-500 mb-1 uppercase tracking-tighter">点击区域复制导出代码</div>
                    <div class="font-mono text-[9px] sm:text-[10px] text-indigo-400 break-all truncate group-hover:text-indigo-300">
                        {{ exportString || '尚未点亮任何卡片...' }}
                    </div>
                </div>
            </div>
        </header>

        <div class="mb-6 flex items-center gap-3 bg-indigo-500/10 border-l-4 border-indigo-500 p-3 sm:p-4 rounded-r-xl">
            <div class="bg-indigo-500 text-white p-1 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
            </div>
            <p class="text-xs sm:text-sm text-indigo-200 font-medium">
                操作说明：点击卡片<span class="text-white font-bold mx-1 text-sm">左半部分</span>减少等级/关闭，点击<span class="text-white font-bold mx-1 text-sm">右半部分</span>增加等级。
            </p>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-2 sm:gap-5">
            <div v-for="card in cards" :key="card.id"
                 class="relative aspect-video rounded-xl sm:rounded-3xl overflow-hidden bg-slate-900 border border-slate-800 shadow-xl sm:shadow-2xl"
                 :class="{ 'skeleton': !card.loaded }">
                <img :src="'./static/cards/s_card-' + card.rarity + '-' + card.id + '.webp'"
                     loading="lazy"
                     @load="card.loaded = true"
                     :class="[
                         'w-full h-full object-cover card-img',
                         card.loaded ? 'card-img-loaded' : '',
                         card.breakLevel === -1 ? 'is-unowned' : ''
                     ]">

                <div v-if="card.breakLevel === -1" class="absolute inset-0 unowned-mask z-10 pointer-events-none"></div>

                <div class="absolute inset-0 flex z-30" v-if="card.loaded">
                    <div @click="changeLevel(card, -1)" class="w-1/2 h-full tap-feedback cursor-pointer"></div>
                    <div @click="changeLevel(card, 1)" class="w-1/2 h-full tap-feedback cursor-pointer"></div>
                </div>

                <div class="absolute top-2 left-2 sm:top-4 sm:left-4 z-20" v-if="card.loaded">
                    <img :src="'./static/assets/' + (card.rarity === '3' ? 'ssr' : 'sr') + '_icon.webp'"
                         :class="['rarity-icon', card.breakLevel === -1 ? 'icon-dimmed' : '']">
                </div>

                <div class="absolute top-1.5 right-1.5 sm:top-3 sm:right-3 z-40" v-if="card.loaded">
                    <img v-if="card.attribute" :src="'./static/assets/icon_' + card.attribute + '.webp'"
                         :class="['attr-icon', card.breakLevel === -1 ? 'icon-dimmed' : '']">
                </div>

                <div class="absolute bottom-2 left-3 sm:bottom-4 sm:left-5 z-20" v-if="card.loaded">
                    <div class="lvl-text text-xl sm:text-3xl font-black italic tracking-tighter"
                         :class="card.breakLevel === -1 ? 'text-slate-500' : 'text-white'">
                        {{ getLevelDisplay(card) }}
                    </div>
                </div>
            </div>

        <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90" @click.self="showModal = false">
            <div class="bg-slate-900 p-4 rounded-2xl max-w-4xl w-full max-h-[90vh] flex flex-col shadow-2xl border border-slate-800">
                <div class="flex justify-between items-center mb-4 text-white font-bold px-2">
                    <h3 class="text-sm sm:text-base">汇总长图已生成 (长按保存)</h3>
                    <button @click="showModal = false" class="text-slate-400 hover:text-white text-2xl">✕</button>
                </div>
                <div class="flex-1 overflow-y-auto bg-black rounded-xl p-2">
                    <img :src="generatedImageSrc" class="max-w-full mx-auto">
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const STORAGE_KEY = 'gakuen_box_global_data';

        createApp({
            data() { return { cards: [], showModal: false, generatedImageSrc: null, isGenerating: false } },
            computed: {
                ownedCount() { return this.cards.filter(c => c.breakLevel >= 0).length; },
                exportString() { return this.cards.filter(c => c.breakLevel >= 0).map(c => `${c.rarity}-${parseInt(c.id)}-${c.breakLevel}`).join(','); }
            },
            methods: {
                getLevelDisplay(card) {
                    const lv = card.breakLevel;
                    if (lv === -1) return 'OFF';
                    if (card.rarity === '3') {
                        const m = { 0:'LV.40', 1:'LV.45', 2:'LV.50', 3:'LV.55', 4:'LV.60' };
                        return m[lv];
                    } else {
                        const m = { 0:'LV.30', 1:'LV.35', 2:'LV.40', 3:'LV.45', 4:'LV.50' };
                        return m[lv];
                    }
                },
                
                init() {
                    const localData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                    const allCards = [];
                    for (const [attr, rarities] of Object.entries(CARD_CONFIG)) {
                        for (const [rarity, ids] of Object.entries(rarities)) {
                            ids.forEach(id => {
                                allCards.push({
                                    id: id,
                                    rarity: rarity,
                                    breakLevel: localData[id] !== undefined ? localData[id] : -1,
                                    attribute: attr,
                                    loaded: false
                                });
                            });
                        }
                    }
                    this.cards = allCards.sort((a, b) => (parseInt(b.rarity) - parseInt(a.rarity)) || (parseInt(b.id) - parseInt(a.id)));
                },

                importCode() {
                    const code = prompt("请粘贴导出的代码字符串：");
                    if (!code || code.trim() === "") return;
                    try {
                        const itemArray = code.split(',');
                        const importMap = {};
                        itemArray.forEach(item => {
                            const parts = item.split('-');
                            if (parts.length === 3) {
                                const [rarity, id, lv] = parts;
                                importMap[id.padStart(4, '0')] = parseInt(lv);
                            }
                        });
                        this.cards.forEach(card => {
                            card.breakLevel = importMap[card.id] !== undefined ? importMap[card.id] : -1;
                        });
                        this.saveToLocal();
                        alert("数据继承成功！");
                    } catch (e) {
                        alert("导入失败：请确保代码格式正确");
                    }
                },

                resetData() {
                    if (confirm("确定要清空所有已选择的卡片吗？此操作无法恢复。")) {
                        this.cards.forEach(card => card.breakLevel = -1);
                        this.saveToLocal();
                    }
                },

                async changeLevel(card, step) {
                    let next = card.breakLevel + step;
                    if (next > 4) next = 4;
                    if (next < -1) next = -1;
                    if (card.breakLevel !== next) { 
                        card.breakLevel = next; 
                        this.saveToLocal();
                    }
                },

                saveToLocal() {
                    const storage = {};
                    this.cards.forEach(c => {
                        if (c.breakLevel !== -1) storage[c.id] = c.breakLevel;
                    });
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(storage));
                },

                async copyResult() {
                    const text = this.exportString;
                    if (!text) return alert("没有可导出的数据");
                    try {
                        await navigator.clipboard.writeText(text);
                        alert("代码已成功复制到剪贴板");
                    } catch (e) {
                        const input = document.createElement('textarea');
                        input.value = text; document.body.appendChild(input);
                        input.select(); document.execCommand('copy');
                        document.body.removeChild(input);
                        alert("代码已复制");
                    }
                },
                
                downloadImg(src) { return new Promise((res, rej) => { const i = new Image(); i.onload = () => res(i); i.onerror = rej; i.src = src; }); },
                
                async generateSummaryImage() {
                    const list = this.cards.filter(c => c.breakLevel >= 0); 
                    if (list.length === 0) return;
                    this.isGenerating = true;
                    try {
                        const cols = 3; const cardW = 640; const cardH = 360;
                        const rows = Math.ceil(list.length / cols);
                        const canvas = document.createElement('canvas');
                        canvas.width = cols * cardW; canvas.height = rows * cardH;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#020617'; ctx.fillRect(0, 0, canvas.width, canvas.height);

                        const ui = {
                            ssr: await this.downloadImg('./static/assets/ssr_icon.webp'),
                            sr: await this.downloadImg('./static/assets/sr_icon.webp'),
                            vo: await this.downloadImg('./static/assets/icon_vo.webp'),
                            da: await this.downloadImg('./static/assets/icon_da.webp'),
                            vi: await this.downloadImg('./static/assets/icon_vi.webp'),
                            as: await this.downloadImg('./static/assets/icon_as.webp')
                        };

                        for (let i = 0; i < list.length; i++) {
                            const c = list[i]; const x = (i % cols) * cardW; const y = Math.floor(i / cols) * cardH;
                            const img = await this.downloadImg(`./static/cards/s_card-${c.rarity}-${c.id}.webp`);
                            ctx.drawImage(img, x, y, cardW, cardH);
                            ctx.drawImage(c.rarity==='3'?ui.ssr:ui.sr, x + 20, y + 20, 80, 40);
                            if (c.attribute) ctx.drawImage(ui[c.attribute], x + cardW - 110, y + 10, 100, 100);
                            ctx.save(); 
                            ctx.shadowColor = 'rgba(0, 0, 0, 1)'; ctx.shadowBlur = 8; ctx.shadowOffsetX = 4; ctx.shadowOffsetY = 4;
                            ctx.fillStyle = 'white'; ctx.font = 'italic 900 70px Arial Black'; 
                            ctx.fillText(this.getLevelDisplay(c), x + 25, y + cardH - 25);
                            ctx.restore();
                        }
                        this.generatedImageSrc = canvas.toDataURL('image/jpeg', 0.9);
                        this.showModal = true;
                    } catch (e) { 
                        console.error(e); 
                        alert("绘图失败，请检查 static/assets 资源是否完整"); 
                    } finally { this.isGenerating = false; }
                }
            },
            mounted() { this.init() }
        }).mount('#app');
    </script>
</body>
</html>